# Makefile for the WebAuth test suite

srcdir		= @srcdir@
top_srcdir	= @top_srcdir@
VPATH		= @srcdir@

APACHE_ROOT	= @APACHE_ROOT@
D		= $(DESTDIR)

CC		= @CC@
CFLAGS		= @CFLAGS@
CPPFLAGS	= @CPPFLAGS@
LDFLAGS		= @LDFLAGS@

@SET_MAKE@

SUBDIRS = libwebauth

.PHONY: all check clean depend install

all check: runtests
	@for subdir in $(SUBDIRS); do \
	    echo "making $@ in $$subdir"; \
	    ( cd $$subdir && $(MAKE) $@ ) || exit 1; \
	done
	./runtests $(srcdir)/TESTS

clean:
	rm -f runtests *.o webauth_keyring*
	@for subdir in $(SUBDIRS); do \
	    echo "making $@ in $$subdir"; \
	    ( cd $$subdir && $(MAKE) $@ ) || exit 1; \
	done

depend:
	@for subdir in $(SUBDIRS); do \
	    echo "making $@ in $$subdir"; \
	    ( cd $$subdir && $(MAKE) $@ ) || exit 1; \
	done

install:
	cp mod_webauth/conf/webauth-tests.conf $D$(APACHE_ROOT)/conf/
	cp -r mod_webauth/htdocs/tests $D$(APACHE_ROOT)/htdocs/
	@echo 'WebAuth tests have been installed in $D$(APACHE_ROOT)'
	@echo 'Read $D$(APACHE_ROOT)/conf/webauth-tests.conf for more'
	@echo 'information on how to configure the test suite.'

runtests: runtests.o
	$(CC) $(LDFLAGS) -o $@ runtests.o
