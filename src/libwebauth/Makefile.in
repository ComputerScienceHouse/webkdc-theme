# Makefile for libwebauth
# $Id$

srcdir		= @srcdir@
top_srcdir	= @top_srcdir@
top_builddir	= @top_builddir@
VPATH		= @srcdir@

prefix          = @prefix@
exec_prefix     = @exec_prefix@
libdir		= @libdir@
includedir	= @includedir@
D		= $(DESTDIR)

CC		= @CC@
INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@
LIBTOOL		= $(top_builddir)/libtool
RANLIB		= @RANLIB@

CFLAGS		= @CFLAGS@
CPPFLAGS	= -I. -I$(srcdir) -I$(top_builddir) @CPPFLAGS@ \
		  @CRYPTO_CPPFLAGS@ @KRB5_CPPFLAGS@
LDFLAGS		= @LDFLAGS@
VERSION_LDFLAGS	= @VERSION_LDFLAGS@
LDLIBS		= @CRYPTO_LIBS@ @KRB5_LIBS@ @LIBS@

LIBNAME		= libwebauth

OBJS		= attrs.o base64.o key.o krb5.o misc.o random.o token.o
LOBJS		= $(OBJS:.o=.lo)

.SUFFIXES: .lo

all: $(LIBNAME).la

install: $(LIBNAME).la
	$(INSTALL) -d $D$(libdir) $D$(includedir)
	$(LIBTOOL) --mode=install \
	    $(INSTALL) $(LIBNAME).la $D$(libdir)/$(LIBNAME).la
	$(INSTALL_DATA) webauth.h $D$(includedir)/webauth.h

.c.lo:
	$(LIBTOOL) --mode=compile $(CC) $(CPPFLAGS) $(CFLAGS) -c $<

# Work around an annoying problem trying to get the modules built without
# hard-coding any rpath in the module by pointing the module builds at the
# .libs directory.  This requires that there not be a .la file in the .libs
# directory to confuse libtool.
$(LIBNAME).la: $(LOBJS)
	$(LIBTOOL) --mode=link $(CC) -o $@ $(LOBJS) $(LDFLAGS) $(LDLIBS) \
	    -rpath $(libdir) -version-info 2:3:1 $(VERSION_LDFLAGS)
	rm -f .libs/$(LIBNAME).la

clean:
	rm -rf *.o $(LIBNAME).la *.lo .libs *~ core \#*

depend:
	$(top_srcdir)/tools/makedepend '$(CPPFLAGS)' *.c

# make depend won't pick up one or the other of these dependencies.
krb5.o: krb5-mit.c krb5-heimdal.c

# DO NOT DELETE THIS LINE -- make depend depends on it.
attrs.o: attrs.c webauthp.h $(top_builddir)/config.h webauth.h
base64.o: base64.c webauthp.h $(top_builddir)/config.h webauth.h
key.o: key.c webauthp.h $(top_builddir)/config.h webauth.h
krb5-heimdal.o: krb5-heimdal.c
krb5-mit.o: krb5-mit.c
krb5.o: krb5.c webauthp.h $(top_builddir)/config.h webauth.h krb5-mit.c
misc.o: misc.c webauthp.h $(top_builddir)/config.h webauth.h
random.o: random.c webauthp.h $(top_builddir)/config.h webauth.h
token.o: token.c webauthp.h $(top_builddir)/config.h webauth.h
