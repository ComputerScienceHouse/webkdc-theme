#!/usr/pubsw/bin/perl

use strict;
use warnings;

use lib '../bindings/perl/WebAuth/blib/lib';
use lib '../bindings/perl/WebAuth/blib/arch/auto/WebAuth';

use WebAuth qw(:base64 :const :krb5 :key);

use WebKDC;
use WebKDC::Token;
use WebKDC::WebRequest;
use WebKDC::WebResponse;

use Carp;
use UNIVERSAL qw(isa);

use vars qw($CONFIG_WAS_KEYTAB $CONFIG_WAS_KEYRING_PATH);

$CONFIG_WAS_KEYTAB = "shred_webauth.keytab";
$CONFIG_WAS_KEYRING_PATH = "was.keyring";


our $our_keyring = undef;

sub get_was_keyring {
    if (!defined($our_keyring)) {
	$our_keyring = WebAuth::keyring_read_file($CONFIG_WAS_KEYRING_PATH);
    }
    return $our_keyring;
}

sub handle_response($) {
    my ($resp) = @_;

    my $as_token_str = $resp->app_state();

    print "as_token_token b64'd length(".length($as_token_str).")\n";

    my $as_token = new WebKDC::AppToken(base64_decode($as_token_str),
					get_was_keyring(), 0);

    my $key = key_create(WA_AES_KEY, $as_token->session_key());

    my $resp_token_str = $resp->response_token();

    print "response_token b64'd length(".length($resp_token_str).")\n";

    my $id_token = WebKDC::Token::parse(base64_decode($resp_token_str),
					$key, $WebKDC::C_TOKEN_TTL);

    if (!isa($id_token, 'WebKDC::IdToken')) {
	print $id_token;
	croak "response not an IdToken";

    }
    print $id_token;

    my $sad = $id_token->subject_auth_data();

    my $id_princ = krb5_rd_req(krb5_new(), $sad, $CONFIG_WAS_KEYTAB);

    print "id = $id_princ\n";

    my $app_token = new WebKDC::AppToken;

    $app_token->subject("krb5:$id_princ");
    $app_token->creation_time(time());
    $app_token->expiration_time($id_token->expiration_time());

    print $app_token;

    my $app_token_str = base64_encode($app_token->to_token(get_was_keyring()));

    print "app_token b64'd length(".length($app_token_str).")\n";

}

eval {

    my $c = krb5_new();

    krb5_init_via_keytab($c, $CONFIG_WAS_KEYTAB);

    my $princ = krb5_service_principal($c, $WebKDC::C_WEBKDC_K5SERVICE,
				       $WebKDC::C_WEBKDC_HOST);
    my $request = krb5_mk_req($c, $princ);

    my ($service_token_str, $session_key, $st_expiration_time) =
	WebKDC::make_service_token_from_krb5_cred($request);

    print "service_token b64'd length(".length($service_token_str).")\n";

    my $key = key_create(WA_AES_KEY, $session_key);

    my $as_token = new WebKDC::AppToken;

    $as_token->session_key($session_key);
    $as_token->expiration_time($st_expiration_time);

    print $as_token;

    my $req_token = new WebKDC::RequestToken;
    $req_token->app_state($as_token->to_token(get_was_keyring()));
    $req_token->return_url("http://foo.bar.com/");
    $req_token->creation_time(time());
    $req_token->request_reason('na');
    $req_token->requested_token_type('id');
    $req_token->subject_auth('krb5');

    print $req_token;

    my $req_token_str = base64_encode($req_token->to_token($key));

    print "request_token b64'd length(".length($req_token_str).")\n";

    my $req = new WebKDC::WebRequest;
    my $resp = new WebKDC::WebResponse;

    $req->user("schemers/test");
    $req->pass("testing");
    $req->request_token($req_token_str);
    $req->service_token($service_token_str);

    WebKDC::handle_request_token($req, $resp);

    handle_response($resp);

    print "----------------------\n";
    print "----------------------\n";
    print "----------------------\n";

    # try again using proxy-token from response instead of
    # user/pass

    my $proxy_cookie = $resp->proxy_cookie('krb5');

    $req = new WebKDC::WebRequest;
    $resp = new WebKDC::WebResponse;

    $req->proxy_cookie('krb5', $proxy_cookie);
    $req->request_token($req_token_str);
    $req->service_token($service_token_str);

    WebKDC::handle_request_token($req, $resp);

    handle_response($resp);

};

if ($@) {
    print "OOOPS $@\n";
}
